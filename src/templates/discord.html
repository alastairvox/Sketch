{# templates/discord.html #}

<!DOCTYPE html>
<html lang="en">

<head>
    <title>Sketch: Manage Discord</title>
    <link rel="stylesheet" href="static/style.css">
    <script type="text/javascript" src="static/index.js"></script>
</head>

<body>

    {% include "header.html" %}

    <div class="container">
        <div>
            <h1>Manage Guilds</h1>
                {% if guilds %}
                    <ul class="guildList">
                        {% for guild in guilds %}
                            {# TODO list config options for joinroles, re-announce delay, deleting or editing past announcements, timezone, and authorized users #}
                            <li class="guildListItem"><form id="{{guild.id}}-manageGuildForm" class="manageGuildForm" method="POST" action="/discord/config">
                                    <fieldset>
                                        <legend><b>{{ guild.name }} Configuration</b></legend>
                                        <input type="hidden" name="_csrf_token" value="{{csrfToken}}"/>
                                        <input type="hidden" name="guild" value="{{guild.id}}"/>
                                        <label for="{{guild.id}}-timeZone">Server Time Zone: <small>(like <a href="https://gist.github.com/heyalexej/8bf688fd67d7199be4a1682b3eec7568"><code>US/Central</code></a>)</small></label>
                                        <input class="timeZone" type="text" id="{{guild.id}}-timeZone" name="timeZone" value="{{guild.timeZone}}">
                                        <label for="{{guild.id}}-deleteOldAnnouncements">Edit or delete old announcements:</label>
                                        <select class="deleteOldAnnouncements" id="{{guild.id}}-deleteOldAnnouncements" name="deleteOldAnnouncements">
                                            <option value="False"{% if not guild.deleteOldAnnouncements %} selected{% endif %}>Edit</option>
                                            <option value="True"{% if guild.deleteOldAnnouncements %} selected{% endif %}>Delete</option>
                                        </select>
                                        <label for="{{guild.id}}-spamProtectionAnnounceDelay">Announce spam/offline delay: <small>(minutes)</small></label>
                                        <input class="spamProtectionAnnounceDelay" type="number" id="{{guild.id}}-spamProtectionAnnounceDelay" name="spamProtectionAnnounceDelay" value="{{guild.spamProtectionAnnounceDelay}}">
                                        <input type="submit" value="Update">
                                    </fieldset>
                                </form>
                                <ul>
                                    <li><h3>Join Roles:</h3>
                                        <ul>
                                            {% if guild.joinroles %}
                                                {% for role in guild.joinRoles %}
                                                    <li><form id="{{guild.id}}-{{role.id}}-manageJoinRoleForm" class="manageJoinRoleForm" method="POST" action="/discord/joinRole/delete">
                                                        <fieldset>
                                                            <legend><b>{{ role.name }}</b></legend>
                                                            <input type="hidden" name="_csrf_token" value="{{csrfToken}}"/>
                                                            <input type="hidden" name="guild" value="{{guild.id}}"/>
                                                            <input type="hidden" name="roleID" value="{{role.id}}"/>
                                                            <input type="submit" value="Delete">
                                                        </fieldset>
                                                    </form></li>
                                                {% endfor %}
                                            {% else %}
                                                <li>None</li>
                                            {% endif %}
                                            <li><form id="{{guild.id}}-newJoinRoleForm" method="POST" action="/discord/joinRole/add">
                                                <details><summary>Add Join Roles</summary>
                                                    <input type="hidden" name="_csrf_token" value="{{csrfToken}}"/>
                                                    <input type="hidden" name="guild" value="{{guild.id}}"/>
                                                    <label for="{{guild.id}}-roles">Roles: <small>(ctrl+click or click+drag to select multiple)</small></label>
                                                    <br>
                                                    <select class="roles" id="{{guild.id}}-roles" name="roles" size="15" multiple required>
                                                        {% if discordGuilds %}
                                                            {% for role in discordGuilds[guild.id].roles %}
                                                                <option value="{{role.id}}">{{role.name}}</option>
                                                            {% endfor %}
                                                        {% endif %}
                                                    </select>
                                                    <input type="submit" value="Add Roles">
                                                </details>
                                            </form></li>
                                        </ul>
                                    </li>
                                    <li><h3>Twitch Announcements:</h3>
                                        <ul>
                                            {% if guild.twitchAnnouncements %}
                                                {% for announcement in guild.twitchAnnouncements %}
                                                    {% set ns = namespace(currentChannelName='') %}
                                                    {% for channel in discordGuilds[guild.id].text_channels %}
                                                        {% if channel.id == announcement.channelID %}
                                                            {% set ns.currentChannelName = channel.name %}
                                                        {% endif %}
                                                    {% endfor %}
                                                    <li><form id="{{announcement.id}}-manageAnnouncementForm" class="manageAnnouncementForm" method="POST" action="/discord/announcement/delete">
                                                        <fieldset>
                                                            <legend><b>{{ announcement.streamName }}</b></legend>
                                                            <input type="hidden" name="_csrf_token" value="{{csrfToken}}"/>
                                                            <input type="hidden" name="announcementID" value="{{announcement.id}}"/>
                                                            <input type="hidden" name="guild" value="{{guild.id}}"/>
                                                            <input type="hidden" name="streamName" value="{{announcement.streamName}}"/>
                                                            <span>
                                                                #{{ ns.currentChannelName|e }}: {{ announcement.announcementText|e }}
                                                                <div>
                                                                    <button data-guild="{{guild.id}}" data-channel="{{announcement.channelID}}" data-announcement="{{announcement.id}}" type="button" value="Edit" onclick="editAnnouncement(this)">Edit</button>
                                                                    <input type="submit" value="Delete">
                                                                </div>
                                                            </span>
                                                        </fieldset>
                                                    </form></li>
                                                {% endfor %}
                                            {% else %}
                                                <li>None</li>
                                            {% endif %}
                                            <li><form id="{{guild.id}}-newAnnouncementForm" method="POST" action="/discord/announcement/add">
                                                <details><summary>New Announcement</summary>
                                                    <input type="hidden" name="_csrf_token" value="{{csrfToken}}"/>
                                                    <input type="hidden" name="guild" value="{{guild.id}}"/>
                                                    <label for="{{guild.id}}-streamName">Stream:</label>
                                                    <input class="streamName" type="text" id="{{guild.id}}-streamName" name="streamName" maxlength="100" required/>
                                                    <br>
                                                    <label for="{{guild.id}}-channel">Announcement channel:</label>
                                                    <select class="channel" id="{{guild.id}}-channel" name="channel" required>
                                                        {% if discordGuilds %}
                                                            {% for channel in discordGuilds[guild.id].text_channels %}
                                                                <option value="{{channel.id}}">{{channel.name}}</option>
                                                            {% endfor %}
                                                        {% endif %}
                                                    </select>
                                                    <br>
                                                    <label for="{{guild.id}}-announcementText">Announce Message: <small>(To mention by role ID, type <code><@&ROLE_ID></code>. To use custom emoji, find emoji codes by putting <code>\:CUSTOM_EMOJI:</code> into a message on Discord!)</small>
                                                    </label>
                                                    <br>
                                                    <textarea class="announcementText" id="{{guild.id}}-announcementText" name="announcementText" maxlength="1900"></textarea>
                                                    <input type="submit" value="Add Announcement">
                                                </details>
                                            </form></li>
                                        </ul>
                                    </li>
                                    <li><h3>Authorized Users:</h3>
                                        <ul>
                                            {% if guild.authorizedUsers %}
                                                {% for user in guild.authorizedUsers %}
                                                    <li><form id="{{guild.id}}-{{user.id}}-manageAuthForm" class="manageAuthForm" method="POST" action="/discord/authorizedUser/delete">
                                                        <fieldset>
                                                            <legend><b>{% if user.name %}{{ user.name }}{% else %}{{ user.username }}{% endif %}</b></legend>
                                                            <input type="hidden" name="_csrf_token" value="{{csrfToken}}"/>
                                                            <input type="hidden" name="guild" value="{{guild.id}}"/>
                                                            <input type="hidden" name="userID" value="{{user.id}}"/>
                                                            <span>Username: {{ user.username }}</span>
                                                            <input type="submit" value="Delete">
                                                        </fieldset>
                                                    </form></li>
                                                {% endfor %}
                                            {% else %}
                                                <li>None</li>
                                            {% endif %}
                                            <li><form id="{{guild.id}}-newAuthForm" method="POST" action="/discord/authorizedUser/add">
                                                <details><summary>Add Authorized Users</summary>
                                                    <input type="hidden" name="_csrf_token" value="{{csrfToken}}"/>
                                                    <input type="hidden" name="guild" value="{{guild.id}}"/>
                                                    <label for="{{guild.id}}-users">Users: <small>(ctrl+click or click+drag to select multiple)</small></label>
                                                    <br>
                                                    <select class="users" id="{{guild.id}}-users" name="users" size="15" multiple required>
                                                        {% if discordGuilds %}
                                                            {% for member in discordGuilds[guild.id].members %}
                                                                <option value="{{member.id}}">{% if member.global_name %}{{member.global_name}}{% else %}{{ member.name }}{% endif %} ({{member.name}})</option>
                                                            {% endfor %}
                                                        {% endif %}
                                                    </select>
                                                    <input type="submit" value="Add Users">
                                                </details>
                                            </form></li>
                                        </ul>
                                    </li>
                                </ul>
                            </li>
                        {% endfor %}
                    </ul>
                {% endif %}
        </div>
    </div>

</body>

</html>